{% extends "base.html" %}
{% load static %}

{% block title %}Point of Sale{% endblock %}

{% block content %}
<style>
    /* --- PROFESSIONAL UI WITH CUSTOM COLOR SCHEME --- */
    :root {
        --bs-font-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --bs-body-bg: #f8f9fa;
        --brand-accent: #17a2b8; /* Teal accent color from login screen */
        --brand-accent-hover: #138496; /* A darker shade for hover */
        --brand-success: #198754;
        --light-gray: #e9ecef;
        --text-dark: #212529;
        --text-muted: #6c757d;
        --card-bg: #ffffff;
        --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        --card-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    body {
        overflow: hidden;
        background-color: var(--bs-body-bg);
        font-family: var(--bs-font-sans-serif);
    }

    .container-fluid {
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100% !important;
    }

    .pos-container {
        display: flex;
        height: calc(100vh - 70px); /* Adjust based on your navbar height */
    }

    /* --- LEFT SIDE: PRODUCTS CATALOG --- */
    .products-wrapper {
        flex: 3;
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
        overflow: hidden;
    }

    .catalog-header {
        flex-shrink: 0;
        margin-bottom: 1.5rem;
    }

    .search-input-wrapper { position: relative; }
    .search-icon {
        position: absolute; left: 1rem; top: 50%;
        transform: translateY(-50%); color: var(--text-muted);
    }
    .search-input {
        height: 50px; border-radius: 0.5rem; border: 1px solid var(--light-gray);
        padding-left: 2.8rem; font-size: 1rem; box-shadow: none;
    }
    .search-input:focus {
        border-color: var(--brand-accent);
        box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.15);
    }

    .category-filters {
        margin-top: 1rem; display: flex; flex-wrap: nowrap;
        overflow-x: auto; padding-bottom: 0.5rem;
    }
    .cat-btn {
        background: #fff; border: 1px solid var(--light-gray); color: #343a40;
        border-radius: 25px; padding: 0.4rem 1rem; font-weight: 500;
        margin-right: 0.5rem; white-space: nowrap; transition: all 0.2s ease;
    }
    .cat-btn:hover { background: var(--light-gray); }
    .cat-btn.active {
        background-color: var(--brand-accent);
        color: white;
        border-color: var(--brand-accent);
    }

    .product-grid-wrapper { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
    .product-card {
        background: var(--card-bg); border: 1px solid var(--light-gray);
        border-radius: 0.75rem; cursor: pointer; transition: all 0.2s ease;
        box-shadow: var(--card-shadow); height: 100%; display: flex; flex-direction: column;
    }
    .product-card-img {
        height: 120px;
        width: 100%;
        object-fit: cover;
    }
    .product-card-img-placeholder {
        height: 120px;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--light-gray);
    }
    .product-card:hover { transform: translateY(-4px); box-shadow: var(--card-shadow-hover); }
    .product-info { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
    .product-category { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem; }
    .product-name { font-size: 1rem; font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem; }
    .product-sku { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; }
    .product-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
    .product-price { font-size: 1.25rem; font-weight: 700; color: var(--brand-accent); } /* Applied accent color */
    .product-stock { font-size: 0.85rem; font-weight: 500; color: var(--brand-success); }
    
    /* --- RIGHT SIDE: CART --- */
    .cart-wrapper {
        flex: 2; background: var(--card-bg); border-left: 1px solid var(--light-gray);
        display: flex; flex-direction: column; height: 100%;
        box-shadow: -5px 0 20px rgba(0,0,0,0.03);
    }
    .cart-header { padding: 1.5rem; border-bottom: 1px solid var(--light-gray); flex-shrink: 0; }
    .cart-body { flex-grow: 1; overflow-y: auto; padding: 1rem; }
    .cart-item { display: flex; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); }
    .cart-item-details { flex-grow: 1; margin-right: 1rem; }
    .cart-item-name { font-weight: 600; color: var(--text-dark); }
    .cart-item-price { font-size: 0.9rem; color: var(--text-muted); }
    .cart-item-actions { display: flex; align-items: center; }
    .qty-btn { width: 28px; height: 28px; border: 1px solid #ccc; background: #fff; color: #555; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .qty-display { font-weight: 500; width: 40px; text-align: center; }
    .cart-item-total { font-weight: 700; color: var(--text-dark); min-width: 80px; text-align: right; }
    .cart-footer { padding: 1.5rem; border-top: 1px solid var(--light-gray); background-color: #f8f9fa; flex-shrink: 0; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700; }
    .checkout-btn {
        width: 100%; padding: 0.9rem; font-size: 1.1rem; font-weight: 600;
        border-radius: 0.5rem; background-color: var(--brand-accent); /* Applied accent color */
        border-color: var(--brand-accent);
    }
    .checkout-btn:hover {
        background-color: var(--brand-accent-hover); /* Applied accent color */
        border-color: var(--brand-accent-hover);
    }
    .empty-cart-placeholder { text-align: center; margin-top: 4rem; color: #adb5bd; }
</style>

<div class="pos-container">

    <!-- SECTION 1: PRODUCTS CATALOG -->
    <div class="products-wrapper">
        <div class="catalog-header">
            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="productSearch" class="form-control search-input" placeholder="Scan barcode or search products..." autofocus>
            </div>
            <div class="category-filters" id="categoryFilters">
                <button class="cat-btn active" onclick="filterCategory('all', this)">All Items</button>
            </div>
        </div>
        <div class="product-grid-wrapper">
            <div class="row g-3" id="productGrid">
                <!-- Products will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- SECTION 2: CART -->
    <div class="cart-wrapper">
        <div class="cart-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold"><i class="fas fa-shopping-cart me-2"></i>Current Order</h5>
            <div class="w-50">
                <select id="customerSelect" class="form-select form-select-sm">
                    <option value="">Walk-in Customer</option>
                </select>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="clearCart()" title="Clear Cart">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
        <div class="cart-body" id="cartContainer">
            <div class="empty-cart-placeholder">
                <i class="fas fa-cart-arrow-down fa-3x mb-3"></i>
                <p class="fw-bold">Your cart is empty</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="summary-row">
                <span>Total</span>
                <span id="cartTotalDisplay">₱0.00</span>
            </div>
            <button class="btn btn-primary checkout-btn" id="payBtn" onclick="openPaymentModal()" disabled>
                <i class="fas fa-shield-alt me-2"></i>Pay Now
            </button>
        </div>
    </div>
</div>

<!-- PAYMENT MODAL (Remains the same) -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-cash-register me-2"></i>Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Payment Method Toggle -->
                <div class="mb-4 text-center">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="paymentMethod" id="pmCash" value="CASH" checked onchange="togglePaymentMethod()">
                        <label class="btn btn-outline-success" for="pmCash"><i class="fas fa-money-bill-wave me-2"></i>Cash</label>
                        
                        <input type="radio" class="btn-check" name="paymentMethod" id="pmCredit" value="CREDIT" onchange="togglePaymentMethod()">
                        <label class="btn btn-outline-danger" for="pmCredit"><i class="fas fa-file-invoice-dollar me-2"></i>Charge / Credit</label>
                    </div>
                </div>

                <div class="text-center mb-4">
                    <small class="text-uppercase text-muted fw-bold">Amount Due</small>
                    <h1 class="fw-bold text-dark" id="modalTotalAmount">₱0.00</h1>
                </div>
                <div class="mb-4" id="cashInputGroup">
                    <label class="form-label fw-bold">Cash Tendered</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-light">₱</span>
                        <input type="number" id="amountPaidInput" class="form-control fw-bold" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <div class="alert alert-light border d-flex justify-content-between" id="changeGroup">
                    <span class="fw-bold text-muted">Change:</span>
                    <span class="fw-bold text-success fs-5" id="changeDisplay">₱0.00</span>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success fw-bold px-4" id="confirmPaymentBtn" onclick="processCheckout()" disabled>Complete Sale</button>
            </div>
        </div>
    </div>
</div>

<!-- HIDDEN RECEIPT TEMPLATE (Remains the same) -->
<div id="receipt-area" style="display:none;">
    <!-- The existing receipt HTML is here, no changes needed for UI overhaul -->
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- DATA & STATE ---
    const allProducts = JSON.parse('{{ products_json|safe }}');
    const allCustomers = JSON.parse('{{ customers_json|safe }}');
    const preselectedCustomerId = '{{ preselected_customer_id|default:"" }}';
    let cart = [];
    let currentTotal = 0;
    const csrfToken = '{{ csrf_token }}';

    // --- DOM ELEMENTS ---
    const gridEl = document.getElementById('productGrid');
    const cartEl = document.getElementById('cartContainer');
    const totalDisplay = document.getElementById('cartTotalDisplay');
    const customerSelect = document.getElementById('customerSelect');
    const payBtn = document.getElementById('payBtn');

    // Modal Elements
    let paymentModal;
    const modalTotal = document.getElementById('modalTotalAmount');
    const paidInput = document.getElementById('amountPaidInput');
    const changeDisplay = document.getElementById('changeDisplay');
    const confirmBtn = document.getElementById('confirmPaymentBtn');

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        renderProducts(allProducts);
        renderCustomers();
        renderCategories();
        document.getElementById('productSearch').addEventListener('input', (e) => handleSearch(e.target.value));
        if (paidInput) paidInput.addEventListener('input', calculateChange);
    });

    // --- RENDER FUNCTIONS ---
    function renderProducts(products) {
        gridEl.innerHTML = '';
        if (products.length === 0) {
            gridEl.innerHTML = `<p class="text-muted">No products found.</p>`;
            return;
        }
        products.forEach(p => {
            const div = document.createElement('div');
            div.className = 'col-xl-3 col-lg-4 col-md-6 col-12';
            div.innerHTML = `
                <div class="product-card overflow-hidden" onclick="addToCart(${p.id})">
                    ${ p.image_url
                        ? `<img src="${p.image_url}" class="product-card-img" alt="${p.name}">`
                        : `<div class="product-card-img-placeholder">
                               <i class="fas fa-image fa-2x text-muted opacity-50"></i>
                           </div>`
                    }
                    <div class="product-info">
                        <div class="product-category">${p.category__name || 'Uncategorized'}</div>
                        <div class="product-name" title="${p.name}">${p.name}</div>
                        <small class="product-sku">${p.sku}</small>
                        <div class="product-footer">
                            <div class="product-price">₱${parseFloat(p.price).toLocaleString()}</div>
                            <div class="product-stock">${p.quantity} Left</div>
                        </div>
                    </div>
                </div>
            `;
            gridEl.appendChild(div);
        });
    }

    function renderCart() {
        cartEl.innerHTML = '';
        currentTotal = 0;

        if (cart.length === 0) {
            cartEl.innerHTML = `
                <div class="empty-cart-placeholder">
                    <i class="fas fa-cart-arrow-down fa-3x mb-3"></i>
                    <p class="fw-bold">Your cart is empty</p>
                </div>`;
            payBtn.disabled = true;
            totalDisplay.innerText = '₱0.00';
            return;
        }

        cart.forEach((item, index) => {
            const lineTotal = item.price * item.qty;
            currentTotal += lineTotal;

            const row = document.createElement('div');
            row.className = 'cart-item';
            row.innerHTML = `
                <div class="cart-item-details">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-price">₱${item.price.toLocaleString()}</div>
                </div>
                <div class="cart-item-actions">
                    <button class="qty-btn" onclick="updateQty(${index}, -1)"><i class="fas fa-minus fa-xs"></i></button>
                    <span class="qty-display">${item.qty}</span>
                    <button class="qty-btn" onclick="updateQty(${index}, 1)"><i class="fas fa-plus fa-xs"></i></button>
                </div>
                <div class="cart-item-total">₱${lineTotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
            `;
            cartEl.appendChild(row);
        });

        totalDisplay.innerText = '₱' + currentTotal.toLocaleString(undefined, { minimumFractionDigits: 2 });
        payBtn.disabled = false;
    }

    // --- CART LOGIC ---
    function addToCart(id) {
        const product = allProducts.find(p => p.id === id);
        if (!product || product.quantity <= 0) return;

        const existingItem = cart.find(i => i.id === id);

        if (existingItem) {
            if (existingItem.qty >= product.quantity) {
                console.warn(`Max stock for ${product.name} reached.`);
                return;
            }
            existingItem.qty++;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: parseFloat(product.price),
                qty: 1,
                max_stock: product.quantity
            });
        }
        renderCart();
    }

    function updateQty(index, change) {
        const item = cart[index];
        const newQty = item.qty + change;

        if (newQty > item.max_stock) {
            console.warn(`Max stock for ${item.name} reached.`);
            return;
        }

        if (newQty <= 0) {
            cart.splice(index, 1);
        } else {
            item.qty = newQty;
        }
        renderCart();
    }

    function clearCart() {
        if (cart.length > 0 && confirm('Are you sure you want to clear the cart?')) {
            cart = [];
            renderCart();
        }
    }

    // --- CATEGORY & SEARCH ---
    function renderCategories() {
        const categories = [...new Set(allProducts.map(p => p.category__name).filter(Boolean))];
        categories.sort();
        const container = document.getElementById('categoryFilters');
        categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'cat-btn';
            btn.innerText = cat;
            btn.onclick = () => filterCategory(cat, btn);
            container.appendChild(btn);
        });
    }

    function filterCategory(cat, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const filteredProducts = (cat === 'all')
            ? allProducts
            : allProducts.filter(p => p.category__name === cat);

        renderProducts(filteredProducts.filter(p => p.quantity > 0));
    }

    function handleSearch(val) {
        const q = val.toLowerCase().trim();
        const activeCategoryBtn = document.querySelector('.cat-btn.active');
        const activeCategory = activeCategoryBtn.innerText;

        let productsToShow = allProducts;

        if (activeCategory !== 'All Items') {
            productsToShow = allProducts.filter(p => p.category__name === activeCategory);
        }

        const searchedProducts = productsToShow.filter(p =>
            p.name.toLowerCase().includes(q) || p.sku.toLowerCase().includes(q)
        );

        renderProducts(searchedProducts.filter(p => p.quantity > 0));
    }

    // --- CUSTOMER LOGIC ---
    function renderCustomers() {
        allCustomers.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.text = c.name;
            customerSelect.appendChild(option);
        });
        if (preselectedCustomerId) {
            customerSelect.value = preselectedCustomerId;
        }
    }

    // --- PAYMENT & CHECKOUT LOGIC (No changes needed) ---
    function openPaymentModal() {
        modalTotal.innerText = totalDisplay.innerText;
        paidInput.value = '';
        changeDisplay.innerText = '₱0.00';
        confirmBtn.disabled = true;
        
        // Reset to Cash by default unless pre-selected customer implies credit preference? 
        // For now, default to Cash, user can switch.
        document.getElementById('pmCash').checked = true;
        togglePaymentMethod();
        
        paymentModal.show();
        setTimeout(() => paidInput.focus(), 500);
    }

    function togglePaymentMethod() {
        const isCredit = document.getElementById('pmCredit').checked;
        const cashInputGroup = document.getElementById('cashInputGroup');
        const changeGroup = document.getElementById('changeGroup');
        
        if (isCredit) {
            cashInputGroup.style.display = 'none';
            changeGroup.style.display = 'none';
            confirmBtn.disabled = false; // Credit doesn't need cash validation
        } else {
            cashInputGroup.style.display = 'block';
            changeGroup.style.display = 'flex';
            calculateChange(); // Re-validate cash
        }
    }

    function calculateChange() {
        const paid = parseFloat(paidInput.value) || 0;
        const change = paid - currentTotal;
        changeDisplay.innerText = '₱' + change.toLocaleString(undefined, { minimumFractionDigits: 2 });

        if (change >= 0) {
            changeDisplay.classList.remove('text-danger');
            changeDisplay.classList.add('text-success');
            confirmBtn.disabled = false;
        } else {
            changeDisplay.classList.add('text-danger');
            changeDisplay.classList.remove('text-success');
            confirmBtn.disabled = true;
        }
    }

    function processCheckout() {
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        confirmBtn.disabled = true;
        const amountPaid = parseFloat(paidInput.value);
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        const customerId = customerSelect.value;

        if (paymentMethod === 'CREDIT' && !customerId) {
            alert("Please select a customer for Charge/Credit transactions.");
            confirmBtn.disabled = false;
            confirmBtn.innerText = 'Complete Sale';
            return;
        }

        fetch("{% url 'inventory:pos_checkout' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ 
                items: cart, 
                amount_paid: amountPaid,
                payment_method: paymentMethod,
                customer_id: customerId
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                paymentModal.hide();
                // NOTE: The hidden receipt print logic is untouched and will work as before.
                // printReceipt(data); 
                alert('Sale Completed Successfully!');
                cart = [];
                renderCart();
                setTimeout(() => location.reload(), 1000); // Reload to get fresh stock data
            } else {
                alert(`Error: ${data.message}`);
                confirmBtn.innerText = 'Complete Sale';
                confirmBtn.disabled = false;
            }
        })
        .catch(err => {
            console.error('Checkout Error:', err);
            alert('A connection error occurred. Please try again.');
            confirmBtn.disabled = false;
            confirmBtn.innerText = 'Complete Sale';
        });
    }
</script>
{% endblock %}