{% extends "base.html" %}
{% load static %}

{% block title %}Point of Sale{% endblock %}

{% block content %}
<style>
    /* --- POS LAYOUT --- */
    body {
        overflow: hidden;
        background-color: #f0f2f5;
    }

    /* Remove padding from base container for full width */
    .container-fluid {
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100% !important;
    }

    .pos-wrapper {
        height: calc(100vh - 70px);
        display: flex;
    }

    /* LEFT: PRODUCT CATALOG */
    .pos-products {
        width: 65%;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .search-bar-container {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #f0f2f5;
        padding-bottom: 15px;
    }

    .search-input {
        height: 55px;
        font-size: 1.2rem;
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        padding-left: 50px;
    }

    .search-icon {
        position: absolute;
        left: 20px;
        top: 18px;
        color: #aaa;
        font-size: 1.2rem;
    }

    .category-filter-container {
        margin-bottom: 15px;
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 5px;
    }

    .cat-btn {
        border-radius: 20px;
        padding: 8px 20px;
        font-weight: 600;
        font-size: 0.9rem;
        border: none;
        background: #fff;
        color: #555;
        transition: all 0.2s;
        margin-right: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .cat-btn.active,
    .cat-btn:hover {
        background: var(--brand-primary);
        color: white;
        transform: translateY(-2px);
    }

    .product-card {
        border: none;
        border-radius: 12px;
        transition: all 0.2s;
        cursor: pointer;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        overflow: hidden;
        height: 100%;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--brand-primary);
    }

    .product-card.oos {
        opacity: 0.5;
        pointer-events: none;
        background: #eee;
    }

    .p-price {
        color: var(--brand-primary);
        font-weight: 800;
        font-size: 1.1rem;
    }

    /* RIGHT: CART (Dark Theme) */
    .pos-cart {
        width: 35%;
        background: #2c3e50;
        color: white;
        display: flex;
        flex-direction: column;
        border-left: 1px solid #34495e;
        height: 100%;
    }

    .cart-header {
        padding: 20px;
        background: #1a252f;
        border-bottom: 1px solid #34495e;
    }

    .cart-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0;
    }

    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #34495e;
        transition: background 0.2s;
    }

    .cart-item:hover {
        background: #34495e;
    }

    .qty-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 1px solid #7f8c8d;
        background: transparent;
        color: #ecf0f1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.2s;
    }

    .qty-btn:hover {
        background: white;
        color: #2c3e50;
        border-color: white;
    }

    .cart-footer {
        padding: 25px;
        background: #1a252f;
        border-top: 1px solid #34495e;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 20px;
    }

    .pay-btn {
        width: 100%;
        padding: 15px;
        font-size: 1.2rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-radius: 8px;
        background: var(--brand-success);
        border: none;
        color: white;
        transition: 0.3s;
    }

    .pay-btn:hover {
        background: #218c53;
        transform: scale(1.02);
    }

    .pay-btn:disabled {
        background: #7f8c8d;
        cursor: not-allowed;
    }

    /* --- RECEIPT PRINT STYLE --- */
    #receipt-area {
        display: none;
    }

    @media print {
        body * {
            visibility: hidden;
        }

        #receipt-area,
        #receipt-area * {
            visibility: visible;
        }

        #receipt-area {
            display: block;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 10px;
            font-family: 'Courier New', monospace;
            color: black;
        }

        .no-print {
            display: none !important;
        }

        @page {
            margin: 0;
        }
    }
</style>

<div class="pos-wrapper">

    <!-- SECTION 1: PRODUCTS -->
    <div class="pos-products">
        <!-- Search -->
        <div class="search-bar-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="productSearch" class="form-control search-input"
                placeholder="Scan barcode or search item..." autofocus>
        </div>

        <!-- Categories -->
        <div class="category-filter-container" id="categoryFilters">
            <button class="cat-btn active" onclick="filterCategory('all', this)">All Items</button>
            <!-- JS Populated -->
        </div>

        <!-- Grid -->
        <div class="row g-3" id="productGrid">
            <!-- JS Populated -->
        </div>
    </div>

    <!-- SECTION 2: CART -->
    <div class="pos-cart">
        <div class="cart-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold"><i class="fas fa-shopping-basket me-2"></i> Current Order</h5>
            <button class="btn btn-sm btn-outline-danger" onclick="clearCart()" title="Clear">
                <i class="fas fa-trash"></i>
            </button>
        </div>

        <div class="cart-body" id="cartContainer">
            <div class="text-center text-muted mt-5">
                <i class="fas fa-cart-arrow-down fa-3x mb-3 opacity-25"></i>
                <p>Cart is empty</p>
            </div>
        </div>

        <div class="cart-footer">
            <div class="d-flex justify-content-between mb-2 text-secondary">
                <span>Items</span>
                <span id="totalItems">0</span>
            </div>
            <div class="total-row">
                <span>Total</span>
                <span id="cartTotalDisplay">₱0.00</span>
            </div>
            <button class="pay-btn shadow" id="payBtn" onclick="openPaymentModal()" disabled>
                <i class="fas fa-money-bill-wave me-2"></i> Pay Now
            </button>
        </div>
    </div>
</div>

<!-- PAYMENT MODAL -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-cash-register me-2"></i>Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <small class="text-uppercase text-muted fw-bold">Amount Due</small>
                    <h1 class="fw-bold text-dark" id="modalTotalAmount">₱0.00</h1>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Cash Tendered</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-light">₱</span>
                        <input type="number" id="amountPaidInput" class="form-control fw-bold" placeholder="0.00"
                            step="0.01">
                    </div>
                </div>

                <div class="alert alert-light border d-flex justify-content-between">
                    <span class="fw-bold text-muted">Change:</span>
                    <span class="fw-bold text-success fs-5" id="changeDisplay">₱0.00</span>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success fw-bold px-4" id="confirmPaymentBtn"
                    onclick="processCheckout()" disabled>
                    Complete Sale
                </button>
            </div>
        </div>
    </div>
</div>

<!-- HIDDEN RECEIPT TEMPLATE -->
<div id="receipt-area">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card border-0" id="receipt-card">
                <div class="card-body p-0" style="font-family: Arial, sans-serif; color: black;">

                    <!-- Header -->
                    <div class="text-center mb-2">
                        <div class="mb-2">
                            <img src="{% static 'images/logo.png' %}" alt="Logo"
                                style="max-height: 80px; filter: grayscale(100%);">
                        </div>

                        <h2 class="fw-bold mb-0 text-uppercase" style="font-size: 1.8rem;">RICH LAND AUTO SUPPLY</h2>
                        <p class="mb-0 small">Stephen Tan Bldg., Osmeña Extn., Brgy. 26, City of Cagayan de Oro, Mis.
                            Or., Phil.</p>
                        <p class="mb-0 fw-bold small">FRANCISCO M. NARSICO - Proprietor</p>
                        <p class="mb-0 small">Mobile No.: 0917-721-3234 ; Tel. No. (088) 323-5445</p>
                        <p class="mb-0 small">VAT Reg. TIN: 103-169-755-0000</p>
                        <p class="mb-0 small">Email: autosupplyrichland@gmail.com ; FB Page: Rich Land Auto Supply</p>
                    </div>

                    <div class="row mt-4 mb-2">
                        <div class="col-12 text-end">
                            <h4 class="fw-bold text-uppercase border-bottom border-dark border-2 d-inline-block px-3">
                                CHARGE INVOICE</h4>
                        </div>
                    </div>

                    <!-- Customer Info Section -->
                    <div class="row mb-3 small">
                        <div class="col-7 pe-1">
                            <div class="d-flex align-items-end mb-2">
                                <span class="me-2" style="white-space: nowrap;">CHARGED TO:</span>
                                <div class="border-bottom border-dark w-100">&nbsp;</div>
                            </div>
                            <div class="d-flex align-items-end">
                                <span class="me-2">Address:</span>
                                <div class="border-bottom border-dark w-100">&nbsp;</div>
                            </div>
                        </div>
                        <div class="col-5 ps-1">
                            <div class="d-flex align-items-end mb-1">
                                <span class="me-2" style="min-width: 50px;">Date:</span>
                                <div class="border-bottom border-dark flex-grow-1 text-center fw-bold" id="rec-date">
                                    <!-- JS Date -->
                                </div>
                            </div>
                            <div class="d-flex align-items-end mb-1">
                                <span class="me-2" style="min-width: 50px;">Terms:</span>
                                <div class="border-bottom border-dark flex-grow-1">&nbsp;</div>
                            </div>
                            <div class="d-flex align-items-end">
                                <span class="me-2" style="min-width: 50px;">TIN No.:</span>
                                <div class="border-bottom border-dark flex-grow-1">&nbsp;</div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div class="table-responsive mb-0">
                        <table class="table table-bordered border-dark table-sm mb-0 align-middle">
                            <thead class="text-center align-middle">
                                <tr style="border-bottom: 2px solid black;">
                                    <th class="py-2 text-uppercase" style="width: 55%;">DESCRIPTION</th>
                                    <th class="py-2 text-uppercase" style="width: 10%;">QTY</th>
                                    <th class="py-2 text-uppercase" style="width: 15%;">UNIT PRICE</th>
                                    <th class="py-2 text-uppercase" style="width: 20%;">AMOUNT</th>
                                </tr>
                            </thead>
                            <tbody class="border-dark" id="rec-items">
                                <!-- JS Populated -->
                            </tbody>
                            <tfoot class="border-dark">
                                <tr>
                                    <td colspan="3" class="text-end fw-bold py-2 pe-3 border-dark">TOTAL AMOUNT DUE</td>
                                    <td class="text-end fw-bold py-2 pe-2 border-dark" id="rec-total">
                                        <!-- JS Total -->
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Signatures -->
                    <div class="row mt-5 pt-4">
                        <div class="col-6">
                            <div class="d-flex flex-column">
                                <span class="small ps-1 mb-4">Processed By:</span>
                                <div class="border-bottom border-dark w-75 mx-auto"></div>
                                <div class="text-center small mt-1" id="rec-cashier"><!-- JS Cashier --></div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex flex-column">
                                <span class="small ps-1 mb-4">Checked By:</span>
                                <div class="border-bottom border-dark w-75 mx-auto"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Note -->
                    <div class="text-center mt-5 pt-2">
                        <p class="small mb-0 fst-italic">"Thank you for your business!"</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- DATA & STATE ---
    const allProducts = JSON.parse('{{ products_json|safe }}');
    let cart = [];
    let currentTotal = 0;
    const csrfToken = '{{ csrf_token }}';

    // --- DOM ELEMENTS ---
    const gridEl = document.getElementById('productGrid');
    const cartEl = document.getElementById('cartContainer');
    const totalDisplay = document.getElementById('cartTotalDisplay');
    const totalItems = document.getElementById('totalItems');
    const payBtn = document.getElementById('payBtn');

    let paymentModal;
    const modalTotal = document.getElementById('modalTotalAmount');
    const paidInput = document.getElementById('amountPaidInput');
    const changeDisplay = document.getElementById('changeDisplay');
    const confirmBtn = document.getElementById('confirmPaymentBtn');

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        renderProducts(allProducts);
        renderCategories();
        document.getElementById('productSearch').addEventListener('input', (e) => handleSearch(e.target.value));
        if (paidInput) paidInput.addEventListener('input', calculateChange);
    });

    // --- RENDER FUNCTIONS ---
    function renderProducts(products) {
        gridEl.innerHTML = '';
        products.forEach(p => {
            const isOOS = p.quantity <= 0;
            const div = document.createElement('div');
            div.className = 'col-md-4 col-lg-3 col-6';
            div.innerHTML = `
                <div class="product-card ${isOOS ? 'oos' : ''}" onclick="addToCart(${p.id})">
                    <div class="p-3 d-flex flex-column h-100">
                        <span class="badge bg-light text-secondary border align-self-start mb-2">${p.category__name || 'Item'}</span>
                        <h6 class="fw-bold text-dark text-truncate mb-1" title="${p.name}">${p.name}</h6>
                        <small class="text-muted mb-3">${p.sku}</small>
                        <div class="mt-auto d-flex justify-content-between align-items-center">
                            <span class="p-price">₱${parseFloat(p.price).toLocaleString()}</span>
                            <small class="${isOOS ? 'text-danger fw-bold' : 'text-success'}">
                                ${isOOS ? '0' : p.quantity} Left
                            </small>
                        </div>
                    </div>
                </div>
            `;
            if (!isOOS) gridEl.appendChild(div);
        });
    }

    function renderCart() {
        cartEl.innerHTML = '';
        currentTotal = 0;
        let count = 0;

        if (cart.length === 0) {
            cartEl.innerHTML = `
                <div class="text-center text-muted mt-5">
                    <i class="fas fa-cart-arrow-down fa-3x mb-3 opacity-25"></i>
                    <p>Cart is empty</p>
                </div>`;
            payBtn.disabled = true;
            totalDisplay.innerText = '₱0.00';
            totalItems.innerText = '0';
            return;
        }

        cart.forEach((item, index) => {
            const lineTotal = item.price * item.qty;
            currentTotal += lineTotal;
            count += item.qty;

            const row = document.createElement('div');
            row.className = 'cart-item';
            row.innerHTML = `
                <div style="flex: 1;">
                    <div class="fw-bold text-white text-truncate" style="max-width: 160px;">${item.name}</div>
                    <small class="text-muted">₱${item.price.toLocaleString()} x ${item.qty}</small>
                </div>
                <div class="fw-bold text-warning me-3">₱${lineTotal.toLocaleString()}</div>
                <div class="d-flex gap-2">
                    <button class="qty-btn" onclick="updateQty(${index}, -1)"><i class="fas fa-minus"></i></button>
                    <button class="qty-btn" onclick="updateQty(${index}, 1)"><i class="fas fa-plus"></i></button>
                </div>
            `;
            cartEl.appendChild(row);
        });

        totalDisplay.innerText = '₱' + currentTotal.toLocaleString(undefined, { minimumFractionDigits: 2 });
        totalItems.innerText = count;
        payBtn.disabled = false;
    }

    // --- CART LOGIC ---
    function addToCart(id) {
        const product = allProducts.find(p => p.id === id);
        const existingItem = cart.find(i => i.id === id);

        if (existingItem) {
            if (existingItem.qty + 1 > product.quantity) return alert('Max stock reached');
            existingItem.qty++;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: parseFloat(product.price),
                qty: 1,
                max_stock: product.quantity
            });
        }
        renderCart();
    }

    function updateQty(index, change) {
        const item = cart[index];
        const newQty = item.qty + change;
        if (newQty > item.max_stock) return alert('Max stock reached');
        if (newQty <= 0) cart.splice(index, 1);
        else item.qty = newQty;
        renderCart();
    }

    function clearCart() {
        if (confirm('Clear cart?')) { cart = []; renderCart(); }
    }

    // --- CATEGORY & SEARCH ---
    function renderCategories() {
        const categories = [...new Set(allProducts.map(p => p.category__name).filter(Boolean))];
        categories.sort();
        const container = document.getElementById('categoryFilters');
        categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'cat-btn';
            btn.innerText = cat;
            btn.onclick = () => filterCategory(cat, btn);
            container.appendChild(btn);
        });
    }

    function filterCategory(cat, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if (btn) btn.classList.add('active');
        else document.querySelector('.cat-btn').classList.add('active'); // All button

        if (cat === 'all') renderProducts(allProducts);
        else renderProducts(allProducts.filter(p => p.category__name === cat));
    }

    function handleSearch(val) {
        const q = val.toLowerCase();
        renderProducts(allProducts.filter(p => p.name.toLowerCase().includes(q) || p.sku.toLowerCase().includes(q)));
    }

    // --- PAYMENT & CHECKOUT ---
    function openPaymentModal() {
        modalTotal.innerText = totalDisplay.innerText;
        paidInput.value = '';
        changeDisplay.innerText = '₱0.00';
        confirmBtn.disabled = true;
        if (paymentModal) paymentModal.show();
        setTimeout(() => paidInput.focus(), 500);
    }

    function calculateChange() {
        const paid = parseFloat(paidInput.value) || 0;
        const change = paid - currentTotal;

        changeDisplay.innerText = '₱' + change.toLocaleString(undefined, { minimumFractionDigits: 2 });

        if (change >= 0) {
            changeDisplay.classList.remove('text-danger');
            changeDisplay.classList.add('text-success');
            confirmBtn.disabled = false;
        } else {
            changeDisplay.classList.add('text-danger');
            changeDisplay.classList.remove('text-success');
            confirmBtn.disabled = true;
        }
    }

    function processCheckout() {
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        confirmBtn.disabled = true;
        const amountPaid = parseFloat(paidInput.value);

        fetch("{% url 'inventory:pos_checkout' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ items: cart, amount_paid: amountPaid })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    if (paymentModal) paymentModal.hide();
                    printReceipt(data);
                    cart = [];
                    renderCart();
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert(data.message);
                    confirmBtn.innerText = 'Complete Sale';
                    confirmBtn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert('Connection Error');
                confirmBtn.disabled = false;
            });
    }

    // --- RECEIPT PRINTING ---
    function printReceipt(data) {
        document.getElementById('rec-date').innerText = data.date;
        document.getElementById('rec-cashier').innerText = data.cashier;

        const tbody = document.getElementById('rec-items');
        tbody.innerHTML = '';
        data.items.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td class="ps-2 py-2">${item.name}</td>
                    <td class="text-center py-2">${item.qty}</td>
                    <td class="text-end pe-2 py-2">${item.price}</td>
                    <td class="text-end pe-2 py-2">${item.total}</td>
                </tr>
            `;
        });

        document.getElementById('rec-total').innerHTML = `
            <div class="d-flex justify-content-between">
                <span>&#8369;</span>
                <span>${data.total}</span>
            </div>
        `;

        window.print();
    }
</script>
{% endblock %}