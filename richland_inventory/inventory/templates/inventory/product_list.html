{% extends "base.html" %}
{% load humanize %}

{% block title %}Inventory List{% endblock %}

{% block content %}
<div class="container-fluid pb-5">
    
    <!-- 1. HEADER & ACTIONS -->
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Product Inventory</h2>
            <p class="text-muted small mb-0">Manage catalog, track stock levels, and pricing.</p>
        </div>
        <div class="d-flex gap-2">
            <!-- TOGGLE FILTER BUTTON -->
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel">
                <i class="fas fa-filter me-2"></i>Filters
            </button>
            
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="fas fa-folder-plus me-2"></i>Category
            </button>
            {% if perms.inventory.add_product %}
                <a href="{% url 'inventory:product_create' %}" class="btn btn-primary shadow-sm">
                    <i class="fas fa-plus me-2"></i>New Product
                </a>
            {% endif %}
        </div>
    </div>

    <!-- 2. FILTER TOOLBAR (Collapsible) -->
    <div class="collapse show" id="filterPanel">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-3 bg-white rounded-3">
                <form method="get" action="" 
                      class="row g-2 align-items-center"
                      hx-get="{% url 'inventory:product_list' %}" 
                      hx-target="#product-table-body" 
                      hx-trigger="change from:select, keyup delay:500ms from:input">
                    
                    <!-- Search -->
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                            {{ filter_form.q }}
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="col-md-2">
                        {{ filter_form.category }}
                    </div>
                    <div class="col-md-2">
                        {{ filter_form.stock_status }}
                    </div>
                    <div class="col-md-2">
                        {{ filter_form.product_status }}
                    </div>
                    
                    <!-- Sort & Reset -->
                    <div class="col-md-2 d-flex gap-2">
                        {{ filter_form.sort_by }}
                        <a href="{% url 'inventory:product_list' %}" class="btn btn-light border" title="Reset Filters">
                            <i class="fas fa-redo-alt text-muted"></i>
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 3. VIEW TOGGLE & DATA -->
    <div class="d-flex justify-content-end mb-3">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary active" id="table-view-btn" title="List View"><i class="fas fa-list"></i></button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="card-view-btn" title="Grid View"><i class="fas fa-th-large"></i></button>
        </div>
    </div>

    <!-- TABLE VIEW -->
    <div id="table-view">
        <div class="card border-0 shadow-sm overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th style="width: 30%;" class="ps-4">Product Details</th>
                            <th style="width: 15%;">Category</th>
                            <th style="width: 20%;">Stock Level</th>
                            <th style="width: 15%;" class="text-end">Price</th>
                            <th style="width: 10%;" class="text-center">Status</th>
                            <th style="width: 10%;"></th> <!-- Actions -->
                        </tr>
                    </thead>
                    <tbody id="product-table-body" class="bg-white">
                        {% include 'inventory/partials/product_list_rows.html' %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- CARD VIEW (Grid) -->
    <div id="card-view" style="display: none;">
        <div class="row g-4">
            {% for product in product_list %}
            <div class="col-md-6 col-lg-4 col-xl-3">
                <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <span class="badge bg-light text-secondary border">{{ product.category.name|default:"Uncategorized" }}</span>
                            {% if product.status == 'ACTIVE' %}
                                <i class="fas fa-check-circle text-success" title="Active"></i>
                            {% else %}
                                <i class="fas fa-ban text-muted" title="Deactivated"></i>
                            {% endif %}
                        </div>
                        
                        <h5 class="card-title fw-bold mb-1">
                            <a href="{{ product.get_absolute_url }}" class="text-dark text-decoration-none stretched-link">{{ product.name }}</a>
                        </h5>
                        <p class="text-muted small font-monospace mb-3">{{ product.sku }}</p>
                        
                        <div class="mt-auto">
                            <h4 class="fw-bold text-primary mb-3">â‚±{{ product.price|floatformat:2|intcomma }}</h4>
                            
                            <div class="d-flex justify-content-between align-items-end small mb-1">
                                <span class="text-muted">Stock: {{ product.quantity|intcomma }}</span>
                                {% if product.quantity <= product.reorder_level %}
                                    <span class="text-warning fw-bold">Low Stock</span>
                                {% endif %}
                            </div>
                            <div class="progress" style="height: 4px;">
                                {% widthratio product.quantity product.reorder_level 100 as pct %}
                                <div class="progress-bar {% if product.quantity <= product.reorder_level %}bg-warning{% else %}bg-success{% endif %}" 
                                     style="width: {{ pct|default:100 }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-5">
                <div class="text-muted">No products found.</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- 4. PAGINATION -->
    {% if is_paginated %}
    <div class="d-flex justify-content-center mt-5">
        <nav aria-label="Page navigation">
            <ul class="pagination shadow-sm">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link border-0" href="?page={{ page_obj.previous_page_number }}&amp;{{ query_params }}">Previous</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link border-0">Previous</span></li>
                {% endif %}
                
                {% for i in paginator.page_range %}
                    {% if page_obj.number == i %}
                        <li class="page-item active"><span class="page-link border-0">{{ i }}</span></li>
                    {% else %}
                        <li class="page-item"><a class="page-link border-0" href="?page={{ i }}&amp;{{ query_params }}">{{ i }}</a></li>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link border-0" href="?page={{ page_obj.next_page_number }}&amp;{{ query_params }}">Next</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link border-0">Next</span></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-light">
            <h5 class="modal-title fw-bold text-dark">Add New Category</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form method="post" action="{% url 'inventory:add_category_ajax' %}" id="addCategoryForm">
            {% csrf_token %}
            <div class="modal-body p-4">
                <div id="category-form-errors" class="alert alert-danger d-none"></div>
                <label for="{{ category_form.name.id_for_label }}" class="form-label small fw-bold text-uppercase">Category Name</label>
                {{ category_form.name }}
            </div>
            <div class="modal-footer border-top-0 bg-light">
              <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Category</button>
            </div>
          </form>
        </div>
      </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 1. FILTER TOGGLE PERSISTENCE ---
    const filterPanel = document.getElementById('filterPanel');
    const storageKey = 'product_list_filter_state'; 

    if (filterPanel) {
        const savedState = localStorage.getItem(storageKey);
        if (savedState === 'hidden') {
            filterPanel.classList.remove('show');
        } else {
            filterPanel.classList.add('show');
        }

        filterPanel.addEventListener('hidden.bs.collapse', function () {
            localStorage.setItem(storageKey, 'hidden');
        });
        filterPanel.addEventListener('shown.bs.collapse', function () {
            localStorage.setItem(storageKey, 'shown');
        });
    }

    // --- 2. VIEW TOGGLE LOGIC ---
    const tableView = document.getElementById('table-view');
    const cardView = document.getElementById('card-view');
    const tableViewBtn = document.getElementById('table-view-btn');
    const cardViewBtn = document.getElementById('card-view-btn');

    function switchView(viewType) {
        if (viewType === 'card') {
            tableView.style.display = 'none';
            cardView.style.display = 'flex'; // Flex for grid system
            tableViewBtn.classList.remove('active');
            cardViewBtn.classList.add('active');
            localStorage.setItem('product_view_preference', 'card-view');
        } else {
            cardView.style.display = 'none';
            tableView.style.display = 'block';
            cardViewBtn.classList.remove('active');
            tableViewBtn.classList.add('active');
            localStorage.setItem('product_view_preference', 'table-view');
        }
    }

    if (tableViewBtn) tableViewBtn.addEventListener('click', () => switchView('table'));
    if (cardViewBtn) cardViewBtn.addEventListener('click', () => switchView('card'));

    const savedPreference = localStorage.getItem('product_view_preference');
    if (savedPreference === 'card-view') switchView('card');

    // --- 3. CATEGORY AJAX ---
    const categoryForm = document.getElementById('addCategoryForm');
    const categorySelect = document.querySelector('[name="category"]'); // In filter form
    const categoryModalEl = document.getElementById('addCategoryModal');
    const categoryModal = bootstrap.Modal.getOrCreateInstance(categoryModalEl);
    const errorDiv = document.getElementById('category-form-errors');

    if (categoryForm) {
        categoryForm.addEventListener('submit', function(event) {
            event.preventDefault(); 
            const formData = new FormData(categoryForm);
            
            fetch(categoryForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if(categorySelect) {
                        const newOption = document.createElement('option');
                        newOption.value = data.category.id;
                        newOption.textContent = data.category.name;
                        categorySelect.appendChild(newOption);
                    }
                    categoryForm.reset();
                    errorDiv.classList.add('d-none');
                    categoryModal.hide();
                    alert('Category added successfully!');
                } else {
                    errorDiv.textContent = data.errors.name[0];
                    errorDiv.classList.remove('d-none');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }
});
</script>
{% endblock %}