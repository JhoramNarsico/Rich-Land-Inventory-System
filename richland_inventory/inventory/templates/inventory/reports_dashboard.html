{% extends "base.html" %}
{% load humanize %}

{% block title %}Reports Dashboard{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{# The datalabels plugin is not used in the corrected charts, but you can keep it for future use #}
{# <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script> #}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 1. Monthly Sales Trend
  const monthlyCtx = document.getElementById('monthlyTrendChart').getContext('2d');
  new Chart(monthlyCtx, {
    type: 'bar',
    data: { // <-- Corrected: data object was missing
      labels: {{ months|safe }},
      datasets: [{
        label: 'Sales (₱)',
        data: {{ monthly_sales|safe }}, // <-- Corrected: 'data:' key was missing
        backgroundColor: 'rgba(13, 110, 253, 0.7)',
        borderColor: 'rgba(13, 110, 253, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Monthly Sales Revenue ({{ current_year }})'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => '₱' + v.toLocaleString() }
        }
      }
    }
  });

  // 2. Stock Status
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: ['In Stock', 'Low Stock', 'Out of Stock'],
      datasets: [{
        // --- THIS IS THE CORRECTED LINE ---
        data: [{{ stock_status.in_stock }}, {{ stock_status.low_stock }}, {{ stock_status.out_of_stock }}],
        backgroundColor: ['#198754', '#ffc107', '#dc3545']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'right' },
        title: {
          display: true,
          text: 'Stock Status Distribution'
        }
      }
    }
  });

  // 3. Top Sellers
  const topCtx = document.getElementById('topSellersChart').getContext('2d');
  new Chart(topCtx, {
    type: 'bar', // <-- Corrected: 'horizontalBar' is now 'bar'
    data: {
      // NOTE: Assumes 'top_sellers_labels' and 'top_sellers_data' are passed from the view
      labels: {{ top_sellers_labels|safe }},
      datasets: [{
        label: 'Units Sold',
        data: {{ top_sellers_data|safe }},
        backgroundColor: 'rgba(102, 16, 242, 0.7)'
      }]
    },
    options: {
      indexAxis: 'y', // <-- This makes the bar chart horizontal
      responsive: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Top 5 Selling Products by Units Sold'
        }
      }
    }
  });

  // 4. Inventory Value
  const valueCtx = document.getElementById('valueChart').getContext('2d');
  new Chart(valueCtx, {
    type: 'doughnut',
    data: { // <-- Corrected: data object was missing
      labels: ['Current Value', 'Remaining to Target'],
      datasets: [{
        // NOTE: Assumes 'inventory_value' and 'inventory_value_remaining' are passed from view
        data: [{{ inventory_value }}, {{ inventory_value_remaining }}],
        backgroundColor: ['#198754', '#dee2e6'],
        borderWidth: 1,
        borderColor: '#fff'
      }]
    },
    options: {
      cutout: '70%',
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: {
            display: true,
            text: 'Inventory Value vs. Target'
        }
      }
    }
  });
});
</script>

<style>
  @media print {
    .no-print { display: none !important; }
    .report-section { page-break-inside: avoid; }
    .report-section tr { page-break-inside: avoid; }
    .report-section thead { display: table-header-group; }
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 no-print">
  <h1><i class="fas fa-chart-line me-2"></i>Reports Dashboard</h1>
  <div>
    <button class="btn btn-secondary" onclick="window.print()">
        <i class="fas fa-print me-1"></i> Print Report
    </button>
    <a href="{% url 'inventory:reporting' %}" class="btn btn-outline-secondary">
      <i class="fas fa-file-export me-1"></i> Export Data
    </a>
  </div>
</div>

<!-- Year Selector -->
<div class="card mb-4 no-print">
  <div class="card-body">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="year" class="form-label">Select Year</label>
        <select name="year" id="year" class="form-select">
          {% for y in available_years %}
            <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-sync-alt me-1"></i> Load Data
        </button>
      </div>
    </form>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <!-- Monthly Trend -->
    <section class="card mb-4 report-section">
      <div class="card-body">
        <canvas id="monthlyTrendChart" style="min-height: 250px;"></canvas>
      </div>
    </section>
  </div>
  <div class="col-lg-4">
    <!-- Stock Health -->
    <section class="card mb-4 report-section">
      <div class="card-body">
        <canvas id="statusChart" style="min-height: 250px;"></canvas>
      </div>
    </section>
  </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Top Sellers -->
        <section class="card mb-4 report-section">
            <div class="card-body">
                <canvas id="topSellersChart" style="min-height: 250px;"></canvas>
            </div>
        </section>
    </div>
    <div class="col-lg-4">
        <!-- Inventory Value -->
        <section class="card mb-4 report-section">
            <div class="card-body text-center">
                <canvas id="valueChart" style="min-height: 200px;"></canvas>
                <div class="mt-3">
                    <h6 class="text-muted">Target: ₱{{ target_value|intcomma }}</h6>
                    <h5>Current Value: <strong>₱{{ inventory_value|intcomma }}</strong></h5>
                </div>
            </div>
        </section>
    </div>
</div>


<!-- Recent Transactions -->
<section class="card report-section">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Recent Sales Transactions</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Product</th>
            <th class="text-end">Qty</th>
            <th class="text-end">Price</th>
            <th class="text-end">Total</th>
            <th>User</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody>
          {% for tx in recent_transactions %}
          <tr>
            <td>
                <a href="{{ tx.product.get_absolute_url }}">{{ tx.product.name }}</a>
            </td>
            <td class="text-end">{{ tx.quantity }}</td>
            <td class="text-end">₱{{ tx.selling_price|floatformat:2|intcomma }}</td>
            {# Note: The 'mul' filter is not standard in Django. Assumes you have a custom template tag for this. #}
            <td class="text-end"><strong>₱{% widthratio tx.selling_price 1 tx.quantity as total_price %}{{ total_price|floatformat:2|intcomma }}</strong></td>
            <td>{{ tx.user.username }}</td>
            <td>{{ tx.timestamp|date:"M d, Y, P" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="text-center p-4">No sales recorded for this year.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}