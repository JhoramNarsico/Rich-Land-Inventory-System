{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Dashboard</h1>
        <p class="lead mb-0">Welcome back, {{ user.username }}!</p>
    </div>

    <!-- Metric Cards (unchanged) -->
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card text-white bg-primary h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-box-open"></i> Total Products</h5>
                    <p class="card-text fs-2 fw-bold">{{ total_products }}</p>
                    <small>Unique items in inventory</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card text-white bg-success h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-dollar-sign"></i> Total Stock Value</h5>
                    <p class="card-text fs-2 fw-bold">${{ total_stock_value }}</p>
                    <small>Combined value of all items</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card text-white bg-danger h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-exclamation-triangle"></i> Low Stock Items</h5>
                    <p class="card-text fs-2 fw-bold">{{ low_stock_products_count }}</p>
                    <small>Items with quantity 5 or less</small>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Tabbed Interface for Stock Movement -->
    <div class="card mt-4">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="stockTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="graph-tab" data-bs-toggle="tab" data-bs-target="#graph-view" type="button" role="tab" aria-controls="graph-view" aria-selected="true"><i class="fas fa-chart-line"></i> Graph View</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-view" type="button" role="tab" aria-controls="data-view" aria-selected="false"><i class="fas fa-table"></i> Data View</button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="stockTabsContent">
                <!-- Graph Tab Pane -->
                <div class="tab-pane fade show active" id="graph-view" role="tabpanel" aria-labelledby="graph-tab">
                    <h5 class="card-title">Stock Movement (Last 30 Days)</h5>
                    <div style="height: 300px;">
                        <canvas id="stockMovementChart"></canvas>
                    </div>
                </div>
                <!-- Data Table Tab Pane -->
                <div class="tab-pane fade" id="data-view" role="tabpanel" aria-labelledby="data-tab">
                    <h5 class="card-title">Recent Stock Transactions</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>User</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in recent_transactions %}
                                <tr>
                                    <td>
                                        {% if transaction.transaction_type == 'IN' %}
                                            <span class="badge bg-success">Stock In</span>
                                        {% else %}
                                            <span class="badge bg-danger">Stock Out</span>
                                        {% endif %}
                                    </td>
                                    <td><a href="{{ transaction.product.get_absolute_url }}">{{ transaction.product.name }}</a></td>
                                    <td>{{ transaction.quantity }}</td>
                                    <td>{{ transaction.user.username|default:"N/A" }}</td>
                                    <td>{{ transaction.timestamp|date:"F d, Y, P" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">No transactions recorded yet.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recently Added Products Table (unchanged) -->
    <div class="card mt-4">
        <!-- ... (This entire card remains the same) ... -->
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const ctx = document.getElementById('stockMovementChart').getContext('2d');
        const stockMovementChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ graph_labels|safe }},
                datasets: [{
                    label: 'Stock In',
                    data: {{ stock_in_values|safe }},
                    backgroundColor: 'rgba(75, 192, 192, 0.5)'
                }, {
                    label: 'Stock Out',
                    data: {{ stock_out_values|safe }},
                    backgroundColor: 'rgba(255, 99, 132, 0.5)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    });
</script>
{% endblock %}